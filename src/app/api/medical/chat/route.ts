import { NextRequest, NextResponse } from "next/server";
import { generateText, generateWithImage } from "@/lib/ai/client";

export async function POST(req: NextRequest) {
   try {
      const { message, history, imageUrl } = await req.json();

      // 1. Red Flag Detection (Dermatology Emergencies)
      const redFlags = [
         "í˜¸í¡ê³¤ë€", "ìˆ¨ì´ ì°¨", "ê¸°ë„ íì‡„", "ì˜ì‹ ì €í•˜", "ê¸°ì ˆ", "ì‹¤ì‹ ",
         "ì‹¬í•œ ì•Œë ˆë¥´ê¸°", "ì•„ë‚˜í•„ë½ì‹œìŠ¤", "ì˜¨ëª¸ì´ ë¶€ì–´", "ëˆˆì´ ì•ˆ ë– ì ¸",
         "ê³ ì—´", "39ë„", "ì‹¬í•œ í†µì¦", "í™”ìƒ", "ë¬¼ì§‘ì´ ì „ì‹ "
      ];

      const isRedFlag = redFlags.some(flag => message.includes(flag));

      if (isRedFlag) {
         return NextResponse.json({
            role: "ai",
            content: "ğŸš¨ [ì‘ê¸‰ ì•Œë¦¼] \nì§€ê¸ˆ ë§ì”€í•˜ì‹  ì¦ìƒì€ ì‘ê¸‰ ìƒí™©(ì•„ë‚˜í•„ë½ì‹œìŠ¤, ì‹¬í•œ ê°ì—¼/í™”ìƒ ë“±)ì¼ ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤. \n\nì¦‰ì‹œ 119ì— ì—°ë½í•˜ê±°ë‚˜ ê°€ê¹Œìš´ ì‘ê¸‰ì‹¤/í”¼ë¶€ê³¼ ì „ë¬¸ ë³‘ì›ì„ ë°©ë¬¸í•´ ì£¼ì„¸ìš”."
         });
      }

      let responseText = "";

      // 2. Vision Mode (Image + Text)
      if (imageUrl) {
         [ì—­í•  ë° íƒœë„]
ë„ˆëŠ” ì¹œì ˆí•˜ê³  ì „ë¬¸ì ì¸ ** í”¼ë¶€ê³¼ ì „ë¬¸ì˜ ** ë‹¤.ë”±ë”±í•œ AI ë¡œë´‡ì²˜ëŸ¼ ë§í•˜ì§€ ë§ê³ , í™˜ìì™€ 1: 1ë¡œ ëŒ€í™”í•˜ë“¯ì´ ìì—°ìŠ¤ëŸ½ê³  ë”°ëœ»í•œ ** êµ¬ì–´ì²´(í•´ìš”ì²´) ** ë¥¼ ì‚¬ìš©í•˜ë¼.

[í•„ìˆ˜ ì§€ì¹¨]
         1. ** ë¶„ëŸ‰ **: ê³µë°± í¬í•¨ ** 400~500ì ë‚´ì™¸ ** ë¡œ í•µì‹¬ë§Œ ìš”ì•½í•´ì„œ ë‹µë³€í•˜ë¼.ë„ˆë¬´ ê¸¸ê²Œ ë‚˜ì—´í•˜ì§€ ë§ˆë¼.
2. ** êµ¬ì¡° **:
   - ** (1) í”¼ë¶€ ìƒíƒœ ë¶„ì„ **: ì‚¬ì§„ì—ì„œ ê´€ì°°ë˜ëŠ” íŠ¹ì§•(í†¤, ê²°, íŠ¸ëŸ¬ë¸”, ì£¼ë¦„ ë“±)ì„ ë¨¼ì € ì§šì–´ì£¼ë©° ê³µê°í•´ë¼. "ì‚¬ì§„ì„ ë³´ë‹ˆ ~í•œ ë¶€ë¶„ì´ ì‹ ê²½ ì“°ì´ì‹œê² ì–´ìš”." ì²˜ëŸ¼ ë§í•´ë¼.
   - ** (2) ì‹œìˆ  ì¶”ì²œ ë° ê¸°ëŒ€ íš¨ê³¼ **: ë¶„ì„ëœ ìƒíƒœì— ì í•©í•œ ëŒ€í‘œì ì¸ ì‹œìˆ (ë ˆì´ì €, ìŠ¤í‚¨ë¶€ìŠ¤í„°, ë¦¬í”„íŒ… ë“±)ì„ 1~2ê°€ì§€ ë²”ì£¼ë¡œ ì¶”ì²œí•˜ê³ , ê·¸ ì‹œìˆ ì´ ì–´ë–¤ ì›ë¦¬ë¡œ í”¼ë¶€ë¥¼ ê°œì„ í•˜ëŠ”ì§€(ì¥ì  / ê¸°ëŒ€íš¨ê³¼)ë¥¼ ì•Œê¸° ì‰½ê²Œ ì„¤ëª…í•´ë¼.
   - ** (3) ë§ˆë¬´ë¦¬ **: ì •í™•í•œ ì§„ë‹¨ì€ ë‚´ì› ìƒë‹´ì´ í•„ìš”í•¨ì„ ë¶€ë“œëŸ½ê²Œ ì–¸ê¸‰í•˜ë©° ì˜ˆì•½ì„ ìœ ë„í•˜ê±°ë‚˜ ì¶”ê°€ ì§ˆë¬¸ì„ ë˜ì ¸ë¼.
3. ** ê¸ˆì§€ **:
         - "(1) ë¶„ì„", "(2) ì¶”ì²œ" ê°™ì€ ëª©ì°¨ë‚˜ ë²ˆí˜¸ë¥¼ ë¶™ì´ì§€ ë§ˆë¼.ìì—°ìŠ¤ëŸ¬ìš´ ì¤„ê¸€ë¡œ ì´ì–´ë¼.
   - ê³¼ë„í•œ ë©´ì±… ì¡°í•­(ë²•ì  ë¬¸êµ¬)ì„ ê¸°ê³„ì ìœ¼ë¡œ ë¶™ì´ì§€ ë§ê³ , ëŒ€í™” íë¦„ ì†ì— ìì—°ìŠ¤ëŸ½ê²Œ ë…¹ì—¬ë¼.

[ëŒ€í™” ì˜ˆì‹œ]
         "ì‚¬ì§„ì„ ìì„¸íˆ ë³´ë‹ˆ ì–‘ ë³¼ ìª½ì— ë¶‰ì€ ê¸°ê°€ ì¡°ê¸ˆ ë³´ì´ê³ , ì „ì²´ì ìœ¼ë¡œ í”¼ë¶€ê°€ ê±´ì¡°í•´ ë³´ì´ì‹œë„¤ìš”. ì´ëŸ° ì†ê±´ì¡°ì™€ ë¶‰ì€ ê¸°ëŠ” í”¼ë¶€ ì¥ë²½ì´ ì•½í•´ì ¸ì„œ ìƒê¸¸ ìˆ˜ ìˆì–´ìš”. 
ì´ëŸ´ ë•ŒëŠ” 'ìŠ¤í‚¨ë¶€ìŠ¤í„°' ê³„ì—´ì˜ ì‹œìˆ ì´ ë„ì›€ì´ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.ì§„í”¼ì¸µì— ìˆ˜ë¶„ê³¼ ì˜ì–‘ì„ ì§ì ‘ ê³µê¸‰í•´ì¤˜ì„œ ì†ê±´ì¡°ë¥¼ ë¹ ë¥´ê²Œ ì¡ê³  í”¼ë¶€ ê²°ì„ ë§¤ë„ëŸ½ê²Œ ë§Œë“¤ì–´ì£¼ê±°ë“ ìš”.ë˜, ë¶‰ì€ ê¸° ì™„í™”ì—ëŠ” 'ì§„ì • ê´€ë¦¬'ë‚˜ ì•½í•œ ê°•ë„ì˜ 'í˜ˆê´€ ë ˆì´ì €'ë„ íš¨ê³¼ì ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
ë¬¼ë¡  ì‚¬ì§„ë§Œìœ¼ë¡œëŠ” ì •í™•í•œ í”¼ë¶€ ë‘ê»˜ë‚˜ ë¯¼ê°ë„ë¥¼ ë‹¤ ì•Œ ìˆ˜ëŠ” ì—†ì–´ì„œ, ë³‘ì›ì— ì˜¤ì…”ì„œ ì§ì ‘ í”¼ë¶€ ìƒíƒœë¥¼ ì²´í¬í•´ë³´ì‹œë©´ ê°€ì¥ ì •í™•í•œ ì†”ë£¨ì…˜ì„ ë“œë¦´ ìˆ˜ ìˆì„ ê²ƒ ê°™ì•„ìš”.í˜¹ì‹œ í‰ì†Œì— íŠ¹ë³„íˆ ë¶ˆí¸í•˜ì…¨ë˜ ì ì´ ë” ìˆìœ¼ì‹ ê°€ìš” ? "

         [ëŒ€í™” ë‚´ì—­]
${ history.map((msg: any) => `${msg.role === 'user' ? 'ì‚¬ìš©ì' : 'AI'}: ${msg.content}`).join("\n") }
         ì‚¬ìš©ì: ${ message } (ì´ë¯¸ì§€ í¬í•¨ë¨)
         AI:
         `;
         // Extract base64 from data URL if needed
         const base64Data = imageUrl.split(",")[1];
         responseText = await generateWithImage(visionSystemPrompt, base64Data);

      } else {
         // 3. Text-Only Mode (Aesthetic Procedure AI Concierge)
         // Calculate turn count based on history (User + AI = 1 turn, but history is array of messages)
         // history length 0 -> Turn 1
         // history length 2 -> Turn 2
         // history length 4 -> Turn 3
         const currentTurn = Math.floor(history.length / 2) + 1;

         let turnInstruction = "";
         let charLimit = "ê³µë°± í¬í•¨ ìµœëŒ€ 200ì";

         if ([3, 5, 7, 10].includes(currentTurn)) {
            charLimit = "ê³µë°± í¬í•¨ ìµœëŒ€ 400ì";
            turnInstruction = `
         [í˜„ì¬ ëŒ€í™” í„´: ${ currentTurn }ë²ˆì§¸]
** ì¤‘ìš” ì§€ì¹¨ **:
         1. ì´ë²ˆ í„´ì—ì„œëŠ” ì‚¬ìš©ìì˜ ê³ ë¯¼ê³¼ ê´€ë ¨ëœ ** í”¼ë¶€ê³¼ ë¯¸ìš© ì‹œìˆ (ìŠ¤í‚¨ë¶€ìŠ¤í„°, ë¦¬í”„íŒ…, ë ˆì´ì € ë“±) ** ì— ëŒ€í•´ ** ìƒì„¸í•˜ê²Œ ** ì„¤ëª…í•´ì•¼ í•œë‹¤.
2. íŠ¹íˆ í•´ë‹¹ ì‹œìˆ ì˜ ** ì—­í• , ì¥ì , ê·¸ë¦¬ê³  ê¸°ëŒ€ íš¨ê³¼ ** ë¥¼ êµ¬ì²´ì ìœ¼ë¡œ ê¸°ìˆ í•˜ë¼.
3. íŠ¹ì • ìƒí’ˆëª…ë³´ë‹¤ëŠ” 'ìŠ¤í‚¨ë¶€ìŠ¤í„° ê³„ì—´', 'HIFU ë¦¬í”„íŒ…' ì²˜ëŸ¼ ë²”ì£¼ ìœ„ì£¼ë¡œ ì–¸ê¸‰í•˜ê³ , "í”¼ë¶€ê³¼ ì „ë¬¸ì˜ì™€ ìƒì˜í•´ë³´ë¼"ëŠ” ê¶Œìœ ë¥¼ í¬í•¨í•´ë¼.
4. ** [RESERVATION_TRIGGER] ** íƒœê·¸ë¥¼ ë‹µë³€ ë§¨ ë§ˆì§€ë§‰ì— ë°˜ë“œì‹œ í¬í•¨ì‹œì¼œë¼. (ì´ íƒœê·¸ëŠ” ì‚¬ìš©ìì—ê²Œ ë³´ì´ì§€ ì•Šê³  ì˜ˆì•½ ëª¨ë‹¬ì„ ë„ìš°ëŠ” ìš©ë„ì„)
            `;
         }

         const textSystemPrompt = `
ë„ˆëŠ” í•œêµ­ì˜ í”¼ë¶€ê³¼ í™˜ê²½ì„ ì´í•´í•˜ê³  ìˆëŠ” "í”¼ë¶€ ë¯¸ìš© ì‹œìˆ  ìƒë‹´ìš© AI ì»¨ì‹œì–´ì§€"ì´ë‹¤.

[í•„ìˆ˜ ì œì•½ ì‚¬í•­]
         1. ** ì¶œë ¥ ê¸¸ì´ **: ${ charLimit } ì´ë‚´ë¡œ ì‘ì„±í•  ê²ƒ.
2. ** í˜•ì‹ ê¸ˆì§€ **: "(ê³µê°)", "(ë¶„ì„)", "(ì§ˆë¬¸)" ê°™ì€ ** ë¼ë²¨ / ê´„í˜¸ í‘œê¸°ë¥¼ ì ˆëŒ€ í•˜ì§€ ë§ ê²ƒ.** ìì—°ìŠ¤ëŸ¬ìš´ ì¤„ê¸€ë¡œ ì´ì–´ê°ˆ ê²ƒ.
3. ** ë‹µë³€ êµ¬ì¡° **:
         (1) ** ê³µê° **: ì‚¬ìš©ìì˜ ê³ ë¯¼ì— ëŒ€í•´ ê¹Šì´ ê³µê°í•˜ê³  ì•ˆì‹¬ì‹œí‚¤ëŠ” ë”°ëœ»í•œ ë©˜íŠ¸ë¡œ ì‹œì‘.
   (2) ** ìƒì„¸ ë¶„ì„ **: ì‚¬ìš©ìì˜ ì¦ìƒ / ê³ ë¯¼ì— ëŒ€í•´ ** ì „ë¬¸ì ì´ê³  ì„¸ë¶€ì ì¸ ë¶„ì„ ** ì„ ì œê³µí•  ê²ƒ.ë‹¨ìˆœí•œ í˜¸ì‘ì´ ì•„ë‹ˆë¼, í”¼ë¶€ ìƒë¦¬í•™ì  ì›ë¦¬ë‚˜ ìƒíƒœë¥¼ êµ¬ì²´ì ìœ¼ë¡œ ì„¤ëª…í•´ ì¤„ ê²ƒ.
   (3) ** ì§ˆë¬¸ **: ìƒë‹´ì„ ì´ì–´ê°€ê¸° ìœ„í•œ ì§ˆë¬¸ 1ê°€ì§€(í•„ìˆ˜).ì‚¬ìš©ì ë‹µë³€ì— ê·¼ê±°í•´ì„œ ì§ˆë¬¸í•  ê²ƒ.

            ${ turnInstruction }

         [ì—­í•  ë° íƒœë„]
            - ì¹œì ˆí•˜ê³  ë”°ëœ»í•˜ë©°, ì‚¬ìš©ìì˜ ê±±ì •ì„ ëœì–´ì£¼ëŠ” íƒœë„.
- ì˜ë£Œë²• ì¤€ìˆ˜: ì§„ë‹¨ / ì²˜ë°© ê¸ˆì§€, "ë„ì›€ì´ ë  ìˆ˜ ìˆë‹¤" í‘œí˜„ ì‚¬ìš©.
- ** ì‹œìˆ  ì¢…ë¥˜Â·ì¥ë‹¨ì Â·ê³ ë ¤ ìš”ì†Œë¥¼ ë¯¸ë¦¬ ì´í•´í•˜ë„ë¡ ë„ì™€ì£¼ëŠ” ì•ˆë‚´ì ** ì—­í• .

[ëŒ€í™” ë‚´ì—­]
${ history.map((msg: any) => `${msg.role === 'user' ? 'ì‚¬ìš©ì' : 'AI'}: ${msg.content}`).join("\n") }
         ì‚¬ìš©ì: ${ message }
         AI:
         `;
         responseText = await generateText(textSystemPrompt, "medical");
      }

      return NextResponse.json({
         role: "ai",
         content: responseText.trim()
      });

   } catch (error) {
      console.error("Medical Chat API Error:", error);
      return NextResponse.json(
         { error: "Internal Server Error" },
         { status: 500 }
      );
   }
}
