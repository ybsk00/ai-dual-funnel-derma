import { NextRequest, NextResponse } from "next/server";
import { generateText } from "@/lib/ai/client";

export async function POST(req: NextRequest) {
    try {
        const { message, history } = await req.json();

        // 1. Red Flag Detection (Strict + Dental Emergencies)
        const redFlags = [
            "ê°€ìŠ´ í†µì¦", "í‰í†µ", "ìˆ¨ì´ ì°¨", "í˜¸í¡ê³¤ë€", "ë§ˆë¹„", "ì‹¤ì–´ì¦", "ë§ì´ ì•ˆ ë‚˜ì™€",
            "ì˜ì‹ ì €í•˜", "ê¸°ì ˆ", "ì‹¤ì‹ ", "í”¼ë¥¼ í† í•´", "ê°í˜ˆ", "í•˜í˜ˆ", "ì‹¬í•œ ë‘í†µ", "ë²ˆê°œ",
            "39ë„", "ê³ ì—´", "ê²½ë ¨", "ë°œì‘", "ì¹˜ì•„ ë¹ ì§", "í„± ë¹ ì§", "ê¸°ë„ íì‡„"
        ];

        const isRedFlag = redFlags.some(flag => message.includes(flag));

        if (isRedFlag) {
            return NextResponse.json({
                role: "ai",
                content: "ğŸš¨ [ì‘ê¸‰ ì•Œë¦¼] \nì§€ê¸ˆ ë§ì”€í•˜ì‹  ì¦ìƒì€ ì‘ê¸‰ ìƒí™©ì¼ ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤. \n\nì¹˜ì•„ê°€ ë¹ ì§€ê±°ë‚˜ í„±ì´ ë¹ ì§„ ê²½ìš°, ë˜ëŠ” í˜¸í¡ê³¤ë€ì´ ë™ë°˜ëœ ê²½ìš° ì¦‰ì‹œ 119ì— ì—°ë½í•˜ê±°ë‚˜ ê°€ê¹Œìš´ ì‘ê¸‰ì‹¤/ì¹˜ê³¼ëŒ€í•™ë³‘ì›ì„ ë°©ë¬¸í•´ ì£¼ì„¸ìš”."
            });
        }

        // 2. System Prompt for Medical Pre-diagnosis
        const systemPrompt = `
[ì—­í• ]
ë‹¹ì‹ ì€ "AI ìŠ¤ë§ˆì¼ ë´íƒˆì¼€ì–´ ìƒë‹´ì‹¤"ì˜ AIì…ë‹ˆë‹¤.
ë¡œê·¸ì¸í•œ í™˜ìë¥¼ ëŒ€ìƒìœ¼ë¡œ ì§„ë£Œ ì „ 'ì¹˜ê³¼ ì‹¬í™” ì˜ˆì§„'ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
í™˜ìì˜ ì¹˜ì•„/êµ¬ê°• ì¦ìƒì„ ë“£ê³ , ì¹˜ê³¼ì˜ì‚¬ê°€ ì§„ë£Œí•  ë•Œ ì°¸ê³ í•  ìˆ˜ ìˆë„ë¡ êµ¬ì²´ì ì¸ ì •ë³´ë¥¼ ìˆ˜ì§‘í•˜ì„¸ìš”.

[ëª©í‘œ]
- í™˜ìì˜ ì£¼í˜¸ì†Œ(Chief Complaint)ë¥¼ ëª…í™•íˆ íŒŒì•… (ì˜ˆ: ì–´ëŠ ì¹˜ì•„ê°€, ì–¸ì œë¶€í„°, ì–´ë–»ê²Œ ì•„í”ˆì§€).
- ë°œë³‘ ì‹œê¸°, í†µì¦ì˜ ì–‘ìƒ(ìš±ì‹ ê±°ë¦¼, ì‹œë¦¼, ì°Œë¦¿í•¨), ì•…í™”/ì™„í™” ìš”ì¸(ì°¬ë¬¼, ëœ¨ê±°ìš´ë¬¼, ì”¹ì„ ë•Œ) ë“±ì„ ìˆ˜ì§‘.
- ìµœì¢…ì ìœ¼ë¡œ ì¹˜ê³¼ì˜ì‚¬ê°€ ì§„ë£Œí•  ë•Œ ë„ì›€ì´ ë  ìˆ˜ ìˆëŠ” ìš”ì•½ ì •ë³´ë¥¼ ìƒì„±í•˜ê¸° ìœ„í•¨.

[ëŒ€í™” ê·œì¹™]
- ë§íˆ¬: "í™˜ìë‹˜", "~í•˜ì…¨ë‚˜ìš”?", "~ì…ë‹ˆë‹¤" ë“± ì •ì¤‘í•˜ê³  ì „ë¬¸ì ì¸ ì–´ì¡°.
- ê¸¸ì´: í•œ ë²ˆì— 1~2ê°œì˜ ì§ˆë¬¸ë§Œ ë˜ì§ˆ ê²ƒ.
- ê¸ˆì§€: "ë‹¹ì‹ ì€ ì¶©ì¹˜ì…ë‹ˆë‹¤" í™•ì§„ ê¸ˆì§€. "ë°œì¹˜í•´ì•¼ í•©ë‹ˆë‹¤" ë“± ì¹˜ë£Œë²• ë‹¨ì • ê¸ˆì§€.
- íë¦„:
  1. ì¦ìƒ êµ¬ì²´í™” (í†µì¦ ë¶€ìœ„, ê°•ë„, ì§€ì† ì‹œê°„ ë“±)
  2. ë™ë°˜ ì¦ìƒ í™•ì¸ (ì‡ëª¸ ì¶œí˜ˆ, ë¶€ê¸°, ì…ëƒ„ìƒˆ, í„±ê´€ì ˆ ì†Œë¦¬ ë“±)
  3. 3~5í„´ ì •ë„ ì§„í–‰ í›„ì—ëŠ” "ì›ì¥ë‹˜ê»˜ ì „ë‹¬í•´ ë“œë¦´ ì˜ˆì§„í‘œë¥¼ ì •ë¦¬í•˜ê² ìŠµë‹ˆë‹¤." ë¼ê³  ë§ˆë¬´ë¦¬ ë©˜íŠ¸.

[ëŒ€í™” ë‚´ì—­]
${history.map((msg: any) => `${msg.role === 'user' ? 'ì‚¬ìš©ì' : 'AI'}: ${msg.content}`).join("\n")}
ì‚¬ìš©ì: ${message}
AI:
`;

        // 3. Generate Response
        const responseText = await generateText(systemPrompt, "medical");

        return NextResponse.json({
            role: "ai",
            content: responseText.trim()
        });

    } catch (error) {
        console.error("Medical Chat API Error:", error);
        return NextResponse.json(
            { error: "Internal Server Error" },
            { status: 500 }
        );
    }
}
