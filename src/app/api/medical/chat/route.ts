import { NextRequest, NextResponse } from "next/server";
import { generateText, generateWithImage } from "@/lib/ai/client";

export async function POST(req: NextRequest) {
    try {
        const { message, history, imageUrl } = await req.json();

        // 1. Red Flag Detection (Dermatology Emergencies)
        const redFlags = [
            "í˜¸í¡ê³¤ë€", "ìˆ¨ì´ ì°¨", "ê¸°ë„ íì‡„", "ì˜ì‹ ì €í•˜", "ê¸°ì ˆ", "ì‹¤ì‹ ",
            "ì‹¬í•œ ì•Œë ˆë¥´ê¸°", "ì•„ë‚˜í•„ë½ì‹œìŠ¤", "ì˜¨ëª¸ì´ ë¶€ì–´", "ëˆˆì´ ì•ˆ ë– ì ¸",
            "ê³ ì—´", "39ë„", "ì‹¬í•œ í†µì¦", "í™”ìƒ", "ë¬¼ì§‘ì´ ì „ì‹ "
        ];

        const isRedFlag = redFlags.some(flag => message.includes(flag));

        if (isRedFlag) {
            return NextResponse.json({
                role: "ai",
                content: "ğŸš¨ [ì‘ê¸‰ ì•Œë¦¼] \nì§€ê¸ˆ ë§ì”€í•˜ì‹  ì¦ìƒì€ ì‘ê¸‰ ìƒí™©(ì•„ë‚˜í•„ë½ì‹œìŠ¤, ì‹¬í•œ ê°ì—¼/í™”ìƒ ë“±)ì¼ ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤. \n\nì¦‰ì‹œ 119ì— ì—°ë½í•˜ê±°ë‚˜ ê°€ê¹Œìš´ ì‘ê¸‰ì‹¤/í”¼ë¶€ê³¼ ì „ë¬¸ ë³‘ì›ì„ ë°©ë¬¸í•´ ì£¼ì„¸ìš”."
            });
        }

        let responseText = "";

        // 2. Vision Mode (Image + Text)
        if (imageUrl) {
            const visionSystemPrompt = `
ğŸ§´ í”¼ë¶€ ì‚¬ì§„ ì—…ë¡œë“œìš© ë©”ë””ì»¬(ë¯¸ìš©) ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸
ë„ˆëŠ” í•œêµ­ì˜ í”¼ë¶€ê³¼ í™˜ê²½ê³¼ ì˜ë£Œë²•ì  í•œê³„ë¥¼ ì´í•´í•˜ê³  ìˆëŠ” 
"í”¼ë¶€ ì‚¬ì§„ ê¸°ë°˜ ë¯¸ìš© ì‹œìˆ  ìƒë‹´ìš© AI ì»¨ì‹œì–´ì§€"ì´ë‹¤.

[í•„ìˆ˜ ì œì•½ ì‚¬í•­]
1. **ì¶œë ¥ ê¸¸ì´**: ê³µë°± í¬í•¨ **ìµœëŒ€ 250ì** ì´ë‚´ë¡œ í•µì‹¬ë§Œ ê°„ê²°í•˜ê²Œ ì‘ì„±í•  ê²ƒ.
2. **ë‹µë³€ êµ¬ì¡°**: ì•„ë˜ ìˆœì„œë¥¼ ë°˜ë“œì‹œ ì§€í‚¬ ê²ƒ.
   (1) **ê³µê°/ê±±ì •/ê¸ì •**: ì‚¬ìš©ìì˜ ê³ ë¯¼ì— ëŒ€í•´ ê¹Šì´ ê³µê°í•˜ê³  ì•ˆì‹¬ì‹œí‚¤ëŠ” ë”°ëœ»í•œ ë©˜íŠ¸ (í•„ìˆ˜).
   (2) **ì‹œê°ì  ë¶„ì„**: ì‚¬ì§„ì—ì„œ ê´€ì°°ë˜ëŠ” íŠ¹ì§• (ì§„ë‹¨ëª… ì ˆëŒ€ ê¸ˆì§€, "ë³´ì…ë‹ˆë‹¤" ìˆ˜ì¤€).
   (3) **í–¥í›„ í”¼ë¶€ì¹˜ë£Œê³„íš**: í”¼ë¶€ê³¼ì—ì„œ ê³ ë ¤í•  ìˆ˜ ìˆëŠ” ì‹œìˆ /ê´€ë¦¬ ë°©í–¥.
   (4) **ê¸°ëŒ€ íš¨ê³¼**: í•´ë‹¹ ê´€ë¦¬ë¥¼ í†µí•´ ê¸°ëŒ€í•  ìˆ˜ ìˆëŠ” ê¸ì •ì  ë³€í™”.
   (5) **ì¶”ê°€ ì§ˆë¬¸**: ë” ì •í™•í•œ ìƒë‹´ì„ ìœ„í•œ êµ¬ì²´ì ì¸ ì§ˆë¬¸ 1ê°€ì§€ (í•„ìˆ˜).

[ë²•ì /ì•ˆì „ì„± ê°€ì´ë“œë¼ì¸]
- ì§ˆë³‘ ì§„ë‹¨, ì²˜ë°©, í™•ì •ì  ì¹˜ë£Œ ê¶Œìœ  ê¸ˆì§€.
- "ê°œì¸ì°¨ê°€ ìˆë‹¤", "ì „ë¬¸ì˜ ìƒë‹´ì´ í•„ìš”í•˜ë‹¤"ëŠ” ë‰˜ì•™ìŠ¤ ìœ ì§€.

[ëŒ€í™” ë‚´ì—­]
${history.map((msg: any) => `${msg.role === 'user' ? 'ì‚¬ìš©ì' : 'AI'}: ${msg.content}`).join("\n")}
ì‚¬ìš©ì: ${message} (ì´ë¯¸ì§€ í¬í•¨ë¨)
AI:
`;
            // Extract base64 from data URL if needed
            const base64Data = imageUrl.split(",")[1];
            responseText = await generateWithImage(visionSystemPrompt, base64Data);

        } else {
            // 3. Text-Only Mode (Aesthetic Procedure AI Concierge)
            const textSystemPrompt = `
í”¼ë¶€ê³¼ ë©”ë””ì»¬(ë¯¸ìš© ì‹œìˆ ) ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸
ë„ˆëŠ” í•œêµ­ì˜ í”¼ë¶€ê³¼ í™˜ê²½ì„ ì´í•´í•˜ê³  ìˆëŠ” "í”¼ë¶€ ë¯¸ìš© ì‹œìˆ  ìƒë‹´ìš© AI ì»¨ì‹œì–´ì§€"ì´ë‹¤.

[í•„ìˆ˜ ì œì•½ ì‚¬í•­]
1. **ì¶œë ¥ ê¸¸ì´**: ê³µë°± í¬í•¨ **ìµœëŒ€ 200ì** ì´ë‚´ë¡œ í•µì‹¬ë§Œ ê°„ê²°í•˜ê²Œ ì‘ì„±í•  ê²ƒ.
2. **ë‹µë³€ êµ¬ì¡°**: ì•„ë˜ ìˆœì„œë¥¼ ë°˜ë“œì‹œ ì§€í‚¬ ê²ƒ.
   (1) **ê³µê°/ê±±ì •/ê¸ì •**: ì‚¬ìš©ìì˜ ê³ ë¯¼ì— ëŒ€í•´ ê¹Šì´ ê³µê°í•˜ê³  ì•ˆì‹¬ì‹œí‚¤ëŠ” ë”°ëœ»í•œ ë©˜íŠ¸ (ê°€ì¥ ì¤‘ìš”).
   (2) **ë¶„ì„**: ì‚¬ìš©ìì˜ ì¦ìƒ/ê³ ë¯¼ì— ëŒ€í•œ ì „ë¬¸ì ì¸ ë¶„ì„ (ì§„ë‹¨ ì•„ë‹˜).
   (3) **í–¥í›„ í”¼ë¶€ì¹˜ë£Œê³„íš**: í”¼ë¶€ê³¼ì—ì„œ ë…¼ì˜ë  ìˆ˜ ìˆëŠ” ì‹œìˆ /ê´€ë¦¬ ì˜µì…˜.
   (4) **ê¸°ëŒ€ íš¨ê³¼**: ê´€ë¦¬ë¥¼ í†µí•´ ì–»ì„ ìˆ˜ ìˆëŠ” ê°œì„ ì .
   (5) **ì¶”ê°€ ì§ˆë¬¸**: ìƒë‹´ì„ ì´ì–´ê°€ê¸° ìœ„í•œ ì§ˆë¬¸ 1ê°€ì§€ (í•„ìˆ˜).

[ì—­í•  ë° íƒœë„]
- ì¹œì ˆí•˜ê³  ë”°ëœ»í•˜ë©°, ì‚¬ìš©ìì˜ ê±±ì •ì„ ëœì–´ì£¼ëŠ” íƒœë„.
- ì˜ë£Œë²• ì¤€ìˆ˜: ì§„ë‹¨/ì²˜ë°© ê¸ˆì§€, "ë„ì›€ì´ ë  ìˆ˜ ìˆë‹¤" í‘œí˜„ ì‚¬ìš©.

[ëŒ€í™” ë‚´ì—­]
${history.map((msg: any) => `${msg.role === 'user' ? 'ì‚¬ìš©ì' : 'AI'}: ${msg.content}`).join("\n")}
ì‚¬ìš©ì: ${message}
AI:
`;
            responseText = await generateText(textSystemPrompt, "medical");
        }

        return NextResponse.json({
            role: "ai",
            content: responseText.trim()
        });

    } catch (error) {
        console.error("Medical Chat API Error:", error);
        return NextResponse.json(
            { error: "Internal Server Error" },
            { status: 500 }
        );
    }
}
