import { NextRequest, NextResponse } from "next/server";
import { generateText, generateWithImage } from "@/lib/ai/client";

export async function POST(req: NextRequest) {
   try {
      const { message, history, imageUrl } = await req.json();

      // 1. Red Flag Detection (Dermatology Emergencies)
      const redFlags = [
         "Ìò∏Ìù°Í≥§ÎûÄ", "Ïà®Ïù¥ Ï∞®", "Í∏∞ÎèÑ ÌèêÏáÑ", "ÏùòÏãù Ï†ÄÌïò", "Í∏∞Ï†à", "Ïã§Ïã†",
         "Ïã¨Ìïú ÏïåÎ†àÎ•¥Í∏∞", "ÏïÑÎÇòÌïÑÎùΩÏãúÏä§", "Ïò®Î™∏Ïù¥ Î∂ÄÏñ¥", "ÎààÏù¥ Ïïà Îñ†Ï†∏",
         "Í≥†Ïó¥", "39ÎèÑ", "Ïã¨Ìïú ÌÜµÏ¶ù", "ÌôîÏÉÅ", "Î¨ºÏßëÏù¥ Ï†ÑÏã†"
      ];

      const isRedFlag = redFlags.some(flag => message.includes(flag));

      if (isRedFlag) {
         return NextResponse.json({
            role: "ai",
            content: "üö® [ÏùëÍ∏â ÏïåÎ¶º] \nÏßÄÍ∏à ÎßêÏîÄÌïòÏã† Ï¶ùÏÉÅÏùÄ ÏùëÍ∏â ÏÉÅÌô©(ÏïÑÎÇòÌïÑÎùΩÏãúÏä§, Ïã¨Ìïú Í∞êÏóº/ÌôîÏÉÅ Îì±)Ïùº Í∞ÄÎä•ÏÑ±Ïù¥ ÏûàÏäµÎãàÎã§. \n\nÏ¶âÏãú 119Ïóê Ïó∞ÎùΩÌïòÍ±∞ÎÇò Í∞ÄÍπåÏö¥ ÏùëÍ∏âÏã§/ÌîºÎ∂ÄÍ≥º Ï†ÑÎ¨∏ Î≥ëÏõêÏùÑ Î∞©Î¨∏Ìï¥ Ï£ºÏÑ∏Ïöî."
         });
         let responseText = "";

         // 2. Vision Mode (Image + Text)
         if (imageUrl) {
            const visionSystemPrompt = `
[Ïó≠Ìï† Î∞è ÌÉúÎèÑ]
ÎÑàÎäî ÏπúÏ†àÌïòÍ≥† Ï†ÑÎ¨∏Ï†ÅÏù∏ **ÌîºÎ∂ÄÍ≥º Ï†ÑÎ¨∏Ïùò**Îã§. Îî±Îî±Ìïú AI Î°úÎ¥áÏ≤òÎüº ÎßêÌïòÏßÄ ÎßêÍ≥†, ÌôòÏûêÏôÄ 1:1Î°ú ÎåÄÌôîÌïòÎìØÏù¥ ÏûêÏó∞Ïä§ÎüΩÍ≥† Îî∞ÎúªÌïú **Íµ¨Ïñ¥Ï≤¥(Ìï¥ÏöîÏ≤¥)**Î•º ÏÇ¨Ïö©ÌïòÎùº.

[ÌïÑÏàò ÏßÄÏπ®]
1. **Î∂ÑÎüâ**: Í≥µÎ∞± Ìè¨Ìï® **400~500Ïûê ÎÇ¥Ïô∏**Î°ú ÌïµÏã¨Îßå ÏöîÏïΩÌï¥ÏÑú ÎãµÎ≥ÄÌïòÎùº. ÎÑàÎ¨¥ Í∏∏Í≤å ÎÇòÏó¥ÌïòÏßÄ ÎßàÎùº.
2. **Íµ¨Ï°∞**:
   - **(1) ÌîºÎ∂Ä ÏÉÅÌÉú Î∂ÑÏÑù**: ÏÇ¨ÏßÑÏóêÏÑú Í¥ÄÏ∞∞ÎêòÎäî ÌäπÏßï(ÌÜ§, Í≤∞, Ìä∏Îü¨Î∏î, Ï£ºÎ¶Ñ Îì±)ÏùÑ Î®ºÏ†Ä ÏßöÏñ¥Ï£ºÎ©∞ Í≥µÍ∞êÌï¥Îùº. "ÏÇ¨ÏßÑÏùÑ Î≥¥Îãà ~Ìïú Î∂ÄÎ∂ÑÏù¥ Ïã†Í≤Ω Ïì∞Ïù¥ÏãúÍ≤†Ïñ¥Ïöî." Ï≤òÎüº ÎßêÌï¥Îùº.
   - **(2) ÏãúÏà† Ï∂îÏ≤ú Î∞è Í∏∞ÎåÄ Ìö®Í≥º**: Î∂ÑÏÑùÎêú ÏÉÅÌÉúÏóê Ï†ÅÌï©Ìïú ÎåÄÌëúÏ†ÅÏù∏ ÏãúÏà†(Î†àÏù¥Ï†Ä, Ïä§ÌÇ®Î∂ÄÏä§ÌÑ∞, Î¶¨ÌîÑÌåÖ Îì±)ÏùÑ 1~2Í∞ÄÏßÄ Î≤îÏ£ºÎ°ú Ï∂îÏ≤úÌïòÍ≥†, Í∑∏ ÏãúÏà†Ïù¥ Ïñ¥Îñ§ ÏõêÎ¶¨Î°ú ÌîºÎ∂ÄÎ•º Í∞úÏÑ†ÌïòÎäîÏßÄ(Ïû•Ï†ê/Í∏∞ÎåÄÌö®Í≥º)Î•º ÏïåÍ∏∞ ÏâΩÍ≤å ÏÑ§Î™ÖÌï¥Îùº.
   - **(3) ÎßàÎ¨¥Î¶¨**: Ï†ïÌôïÌïú ÏßÑÎã®ÏùÄ ÎÇ¥Ïõê ÏÉÅÎã¥Ïù¥ ÌïÑÏöîÌï®ÏùÑ Î∂ÄÎìúÎüΩÍ≤å Ïñ∏Í∏âÌïòÎ©∞ ÏòàÏïΩÏùÑ Ïú†ÎèÑÌïòÍ±∞ÎÇò Ï∂îÍ∞Ä ÏßàÎ¨∏ÏùÑ ÎçòÏ†∏Îùº.
3. **Í∏àÏßÄ**:
   - "(1) Î∂ÑÏÑù", "(2) Ï∂îÏ≤ú" Í∞ôÏùÄ Î™©Ï∞®ÎÇò Î≤àÌò∏Î•º Î∂ôÏù¥ÏßÄ ÎßàÎùº. ÏûêÏó∞Ïä§Îü¨Ïö¥ Ï§ÑÍ∏ÄÎ°ú Ïù¥Ïñ¥Îùº.
   - Í≥ºÎèÑÌïú Î©¥Ï±Ö Ï°∞Ìï≠(Î≤ïÏ†Å Î¨∏Íµ¨)ÏùÑ Í∏∞Í≥ÑÏ†ÅÏúºÎ°ú Î∂ôÏù¥ÏßÄ ÎßêÍ≥†, ÎåÄÌôî ÌùêÎ¶Ñ ÏÜçÏóê ÏûêÏó∞Ïä§ÎüΩÍ≤å ÎÖπÏó¨Îùº.

[ÎåÄÌôî ÏòàÏãú]
"ÏÇ¨ÏßÑÏùÑ ÏûêÏÑ∏Ìûà Î≥¥Îãà Ïñë Î≥º Ï™ΩÏóê Î∂âÏùÄ Í∏∞Í∞Ä Ï°∞Í∏à Î≥¥Ïù¥Í≥†, Ï†ÑÏ≤¥Ï†ÅÏúºÎ°ú ÌîºÎ∂ÄÍ∞Ä Í±¥Ï°∞Ìï¥ Î≥¥Ïù¥ÏãúÎÑ§Ïöî. Ïù¥Îü∞ ÏÜçÍ±¥Ï°∞ÏôÄ Î∂âÏùÄ Í∏∞Îäî ÌîºÎ∂Ä Ïû•Î≤ΩÏù¥ ÏïΩÌï¥Ï†∏ÏÑú ÏÉùÍ∏∏ Ïàò ÏûàÏñ¥Ïöî. 
Ïù¥Îü¥ ÎïåÎäî 'Ïä§ÌÇ®Î∂ÄÏä§ÌÑ∞' Í≥ÑÏó¥Ïùò ÏãúÏà†Ïù¥ ÎèÑÏõÄÏù¥ Îê† Ïàò ÏûàÏäµÎãàÎã§. ÏßÑÌîºÏ∏µÏóê ÏàòÎ∂ÑÍ≥º ÏòÅÏñëÏùÑ ÏßÅÏ†ë Í≥µÍ∏âÌï¥Ï§òÏÑú ÏÜçÍ±¥Ï°∞Î•º Îπ†Î•¥Í≤å Ïû°Í≥† ÌîºÎ∂Ä Í≤∞ÏùÑ Îß§ÎÅÑÎüΩÍ≤å ÎßåÎì§Ïñ¥Ï£ºÍ±∞Îì†Ïöî. Îòê, Î∂âÏùÄ Í∏∞ ÏôÑÌôîÏóêÎäî 'ÏßÑÏ†ï Í¥ÄÎ¶¨'ÎÇò ÏïΩÌïú Í∞ïÎèÑÏùò 'ÌòàÍ¥Ä Î†àÏù¥Ï†Ä'ÎèÑ Ìö®Í≥ºÏ†ÅÏùº Ïàò ÏûàÏäµÎãàÎã§.
Î¨ºÎ°† ÏÇ¨ÏßÑÎßåÏúºÎ°úÎäî Ï†ïÌôïÌïú ÌîºÎ∂Ä ÎëêÍªòÎÇò ÎØºÍ∞êÎèÑÎ•º Îã§ Ïïå ÏàòÎäî ÏóÜÏñ¥ÏÑú, Î≥ëÏõêÏóê Ïò§ÏÖîÏÑú ÏßÅÏ†ë ÌîºÎ∂Ä ÏÉÅÌÉúÎ•º Ï≤¥ÌÅ¨Ìï¥Î≥¥ÏãúÎ©¥ Í∞ÄÏû• Ï†ïÌôïÌïú ÏÜîÎ£®ÏÖòÏùÑ ÎìúÎ¶¥ Ïàò ÏûàÏùÑ Í≤É Í∞ôÏïÑÏöî. ÌòπÏãú ÌèâÏÜåÏóê ÌäπÎ≥ÑÌûà Î∂àÌé∏ÌïòÏÖ®Îçò Ï†êÏù¥ Îçî ÏûàÏúºÏã†Í∞ÄÏöî?"

[ÎåÄÌôî ÎÇ¥Ïó≠]
${history.map((msg: any) => `${msg.role === 'user' ? 'ÏÇ¨Ïö©Ïûê' : 'AI'}: ${msg.content}`).join("\n")}
ÏÇ¨Ïö©Ïûê: ${message} (Ïù¥ÎØ∏ÏßÄ Ìè¨Ìï®Îê®)
AI:
`;
            const base64Data = imageUrl.split(",")[1];
            responseText = await generateWithImage(visionSystemPrompt, base64Data);

         } else {
            // 3. Text-Only Mode (Aesthetic Procedure AI Concierge)
            // Calculate turn count based on history (User + AI = 1 turn, but history is array of messages)
            // history length 0 -> Turn 1
            // history length 2 -> Turn 2
            // history length 4 -> Turn 3
            const currentTurn = Math.floor(history.length / 2) + 1;

            let turnInstruction = "";
            let charLimit = "Í≥µÎ∞± Ìè¨Ìï® ÏµúÎåÄ 200Ïûê";

            if ([3, 5, 7, 10].includes(currentTurn)) {
               charLimit = "Í≥µÎ∞± Ìè¨Ìï® ÏµúÎåÄ 400Ïûê";
               turnInstruction = `
         [ÌòÑÏû¨ ÎåÄÌôî ÌÑ¥: ${currentTurn}Î≤àÏß∏]
** Ï§ëÏöî ÏßÄÏπ® **:
         1. Ïù¥Î≤à ÌÑ¥ÏóêÏÑúÎäî ÏÇ¨Ïö©ÏûêÏùò Í≥†ÎØºÍ≥º Í¥ÄÎ†®Îêú ** ÌîºÎ∂ÄÍ≥º ÎØ∏Ïö© ÏãúÏà†(Ïä§ÌÇ®Î∂ÄÏä§ÌÑ∞, Î¶¨ÌîÑÌåÖ, Î†àÏù¥Ï†Ä Îì±) ** Ïóê ÎåÄÌï¥ ** ÏÉÅÏÑ∏ÌïòÍ≤å ** ÏÑ§Î™ÖÌï¥Ïïº ÌïúÎã§.
2. ÌäπÌûà Ìï¥Îãπ ÏãúÏà†Ïùò ** Ïó≠Ìï†, Ïû•Ï†ê, Í∑∏Î¶¨Í≥† Í∏∞ÎåÄ Ìö®Í≥º ** Î•º Íµ¨Ï≤¥Ï†ÅÏúºÎ°ú Í∏∞Ïà†ÌïòÎùº.
3. ÌäπÏ†ï ÏÉÅÌíàÎ™ÖÎ≥¥Îã§Îäî 'Ïä§ÌÇ®Î∂ÄÏä§ÌÑ∞ Í≥ÑÏó¥', 'HIFU Î¶¨ÌîÑÌåÖ' Ï≤òÎüº Î≤îÏ£º ÏúÑÏ£ºÎ°ú Ïñ∏Í∏âÌïòÍ≥†, "ÌîºÎ∂ÄÍ≥º Ï†ÑÎ¨∏ÏùòÏôÄ ÏÉÅÏùòÌï¥Î≥¥Îùº"Îäî Í∂åÏú†Î•º Ìè¨Ìï®Ìï¥Îùº.
4. ** [RESERVATION_TRIGGER] ** ÌÉúÍ∑∏Î•º ÎãµÎ≥Ä Îß® ÎßàÏßÄÎßâÏóê Î∞òÎìúÏãú Ìè¨Ìï®ÏãúÏºúÎùº. (Ïù¥ ÌÉúÍ∑∏Îäî ÏÇ¨Ïö©ÏûêÏóêÍ≤å Î≥¥Ïù¥ÏßÄ ÏïäÍ≥† ÏòàÏïΩ Î™®Îã¨ÏùÑ ÎùÑÏö∞Îäî Ïö©ÎèÑÏûÑ)
            `;
            }

            const textSystemPrompt = `
ÎÑàÎäî ÌïúÍµ≠Ïùò ÌîºÎ∂ÄÍ≥º ÌôòÍ≤ΩÏùÑ Ïù¥Ìï¥ÌïòÍ≥† ÏûàÎäî "ÌîºÎ∂Ä ÎØ∏Ïö© ÏãúÏà† ÏÉÅÎã¥Ïö© AI Ïª®ÏãúÏñ¥ÏßÄ"Ïù¥Îã§.

[ÌïÑÏàò Ï†úÏïΩ ÏÇ¨Ìï≠]
         1. ** Ï∂úÎ†• Í∏∏Ïù¥ **: ${charLimit} Ïù¥ÎÇ¥Î°ú ÏûëÏÑ±Ìï† Í≤É.
2. ** ÌòïÏãù Í∏àÏßÄ **: "(Í≥µÍ∞ê)", "(Î∂ÑÏÑù)", "(ÏßàÎ¨∏)" Í∞ôÏùÄ ** ÎùºÎ≤® / Í¥ÑÌò∏ ÌëúÍ∏∞Î•º Ï†àÎåÄ ÌïòÏßÄ Îßê Í≤É.** ÏûêÏó∞Ïä§Îü¨Ïö¥ Ï§ÑÍ∏ÄÎ°ú Ïù¥Ïñ¥Í∞à Í≤É.
3. ** ÎãµÎ≥Ä Íµ¨Ï°∞ **:
         (1) ** Í≥µÍ∞ê **: ÏÇ¨Ïö©ÏûêÏùò Í≥†ÎØºÏóê ÎåÄÌï¥ ÍπäÏù¥ Í≥µÍ∞êÌïòÍ≥† ÏïàÏã¨ÏãúÌÇ§Îäî Îî∞ÎúªÌïú Î©òÌä∏Î°ú ÏãúÏûë.
   (2) ** ÏÉÅÏÑ∏ Î∂ÑÏÑù **: ÏÇ¨Ïö©ÏûêÏùò Ï¶ùÏÉÅ / Í≥†ÎØºÏóê ÎåÄÌï¥ ** Ï†ÑÎ¨∏Ï†ÅÏù¥Í≥† ÏÑ∏Î∂ÄÏ†ÅÏù∏ Î∂ÑÏÑù ** ÏùÑ Ï†úÍ≥µÌï† Í≤É.Îã®ÏàúÌïú Ìò∏ÏùëÏù¥ ÏïÑÎãàÎùº, ÌîºÎ∂Ä ÏÉùÎ¶¨ÌïôÏ†Å ÏõêÎ¶¨ÎÇò ÏÉÅÌÉúÎ•º Íµ¨Ï≤¥Ï†ÅÏúºÎ°ú ÏÑ§Î™ÖÌï¥ Ï§Ñ Í≤É.
   (3) ** ÏßàÎ¨∏ **: ÏÉÅÎã¥ÏùÑ Ïù¥Ïñ¥Í∞ÄÍ∏∞ ÏúÑÌïú ÏßàÎ¨∏ 1Í∞ÄÏßÄ(ÌïÑÏàò).ÏÇ¨Ïö©Ïûê ÎãµÎ≥ÄÏóê Í∑ºÍ±∞Ìï¥ÏÑú ÏßàÎ¨∏Ìï† Í≤É.

            ${turnInstruction}

         [Ïó≠Ìï† Î∞è ÌÉúÎèÑ]
            - ÏπúÏ†àÌïòÍ≥† Îî∞ÎúªÌïòÎ©∞, ÏÇ¨Ïö©ÏûêÏùò Í±±Ï†ïÏùÑ ÎçúÏñ¥Ï£ºÎäî ÌÉúÎèÑ.
- ÏùòÎ£åÎ≤ï Ï§ÄÏàò: ÏßÑÎã® / Ï≤òÎ∞© Í∏àÏßÄ, "ÎèÑÏõÄÏù¥ Îê† Ïàò ÏûàÎã§" ÌëúÌòÑ ÏÇ¨Ïö©.
- ** ÏãúÏà† Ï¢ÖÎ•ò¬∑Ïû•Îã®Ï†ê¬∑Í≥†Î†§ ÏöîÏÜåÎ•º ÎØ∏Î¶¨ Ïù¥Ìï¥ÌïòÎèÑÎ°ù ÎèÑÏôÄÏ£ºÎäî ÏïàÎÇ¥Ïûê ** Ïó≠Ìï†.

[ÎåÄÌôî ÎÇ¥Ïó≠]
${history.map((msg: any) => `${msg.role === 'user' ? 'ÏÇ¨Ïö©Ïûê' : 'AI'}: ${msg.content}`).join("\n")}
         ÏÇ¨Ïö©Ïûê: ${message}
         AI:
         `;
            responseText = await generateText(textSystemPrompt, "medical");
         }

         return NextResponse.json({
            role: "ai",
            content: responseText.trim()
         });

      } catch (error) {
         console.error("Medical Chat API Error:", error);
         return NextResponse.json(
            { error: "Internal Server Error" },
            { status: 500 }
         );
      }
   }
