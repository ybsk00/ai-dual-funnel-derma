import { NextRequest, NextResponse } from "next/server";
import { generateText } from "@/lib/ai/client";

export async function POST(req: NextRequest) {
    try {
        const { message, history } = await req.json();

        // 1. Red Flag Detection (Dermatology Emergencies)
        const redFlags = [
            "í˜¸í¡ê³¤ë€", "ìˆ¨ì´ ì°¨", "ê¸°ë„ íì‡„", "ì˜ì‹ ì €í•˜", "ê¸°ì ˆ", "ì‹¤ì‹ ",
            "ì‹¬í•œ ì•Œë ˆë¥´ê¸°", "ì•„ë‚˜í•„ë½ì‹œìŠ¤", "ì˜¨ëª¸ì´ ë¶€ì–´", "ëˆˆì´ ì•ˆ ë– ì ¸",
            "ê³ ì—´", "39ë„", "ì‹¬í•œ í†µì¦", "í™”ìƒ", "ë¬¼ì§‘ì´ ì „ì‹ "
        ];

        const isRedFlag = redFlags.some(flag => message.includes(flag));

        if (isRedFlag) {
            return NextResponse.json({
                role: "ai",
                content: "ğŸš¨ [ì‘ê¸‰ ì•Œë¦¼] \nì§€ê¸ˆ ë§ì”€í•˜ì‹  ì¦ìƒì€ ì‘ê¸‰ ìƒí™©(ì•„ë‚˜í•„ë½ì‹œìŠ¤, ì‹¬í•œ ê°ì—¼/í™”ìƒ ë“±)ì¼ ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤. \n\nì¦‰ì‹œ 119ì— ì—°ë½í•˜ê±°ë‚˜ ê°€ê¹Œìš´ ì‘ê¸‰ì‹¤/í”¼ë¶€ê³¼ ì „ë¬¸ ë³‘ì›ì„ ë°©ë¬¸í•´ ì£¼ì„¸ìš”."
            });
        }

        // 2. System Prompt for Medical Pre-diagnosis (Dermatology)
        const systemPrompt = `
[ì—­í• ]
ë‹¹ì‹ ì€ "AI ìŠ¤í‚¨ ì½”ì¹˜ ë©”ë””ì»¬ ìƒë‹´ì‹¤"ì˜ AIì…ë‹ˆë‹¤.
ë¡œê·¸ì¸í•œ í™˜ìë¥¼ ëŒ€ìƒìœ¼ë¡œ ì§„ë£Œ ì „ 'í”¼ë¶€ê³¼ ì‹¬í™” ì˜ˆì§„'ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
í™˜ìì˜ í”¼ë¶€ ê³ ë¯¼ì„ ë“£ê³ , í”¼ë¶€ê³¼ ì „ë¬¸ì˜ê°€ ì§„ë£Œí•  ë•Œ ì°¸ê³ í•  ìˆ˜ ìˆë„ë¡ êµ¬ì²´ì ì¸ ì •ë³´ë¥¼ ìˆ˜ì§‘í•˜ì„¸ìš”.

[ëª©í‘œ]
- í™˜ìì˜ ì£¼í˜¸ì†Œ(Chief Complaint)ë¥¼ ëª…í™•íˆ íŒŒì•… (ì˜ˆ: ì—¬ë“œë¦„, ìƒ‰ì†Œì¹¨ì°©, í™ì¡°, ê°€ë ¤ì›€ ë“±).
- ë°œë³‘ ì‹œê¸°, ì¦ìƒì˜ ì–‘ìƒ(ë¶‰ìŒ, ê³ ë¦„, ë”°ê°€ì›€, ê°„ì§€ëŸ¬ì›€), ì•…í™”/ì™„í™” ìš”ì¸(í™”ì¥í’ˆ, ìŠ¤íŠ¸ë ˆìŠ¤, ê³„ì ˆ) ë“±ì„ ìˆ˜ì§‘.
- ìµœì¢…ì ìœ¼ë¡œ ì˜ì‚¬ê°€ ì§„ë£Œí•  ë•Œ ë„ì›€ì´ ë  ìˆ˜ ìˆëŠ” ìš”ì•½ ì •ë³´ë¥¼ ìƒì„±í•˜ê¸° ìœ„í•¨.

[ëŒ€í™” ê·œì¹™]
- ë§íˆ¬: "í™˜ìë‹˜", "~í•˜ì…¨ë‚˜ìš”?", "~ì…ë‹ˆë‹¤" ë“± ì •ì¤‘í•˜ê³  ì „ë¬¸ì ì¸ ì–´ì¡°.
- ê¸¸ì´: í•œ ë²ˆì— 1~2ê°œì˜ ì§ˆë¬¸ë§Œ ë˜ì§ˆ ê²ƒ.
- ê¸ˆì§€: "ë‹¹ì‹ ì€ ì—¬ë“œë¦„ì…ë‹ˆë‹¤" í™•ì§„ ê¸ˆì§€. "ë ˆì´ì € ì¹˜ë£Œë¥¼ ë°›ìœ¼ì„¸ìš”" ë“± ì¹˜ë£Œë²• ë‹¨ì • ê¸ˆì§€.
- íë¦„:
  1. ì¦ìƒ êµ¬ì²´í™” (ë¶€ìœ„, ì¦ìƒ ì¢…ë¥˜, ì§€ì† ì‹œê°„ ë“±)
  2. ë™ë°˜ ì¦ìƒ í™•ì¸ (ê°€ë ¤ì›€, í†µì¦, ì—´ê° ë“±)
  3. ê³¼ê±°ë ¥/ìƒí™œìŠµê´€ (ì‚¬ìš© ì¤‘ì¸ í™”ì¥í’ˆ, ì•½ë¬¼, ì•Œë ˆë¥´ê¸° ë“±)
  4. 3~5í„´ ì •ë„ ì§„í–‰ í›„ì—ëŠ” "ì›ì¥ë‹˜ê»˜ ì „ë‹¬í•´ ë“œë¦´ ì˜ˆì§„í‘œë¥¼ ì •ë¦¬í•˜ê² ìŠµë‹ˆë‹¤." ë¼ê³  ë§ˆë¬´ë¦¬ ë©˜íŠ¸.

[ëŒ€í™” ë‚´ì—­]
${history.map((msg: any) => `${msg.role === 'user' ? 'ì‚¬ìš©ì' : 'AI'}: ${msg.content}`).join("\n")}
ì‚¬ìš©ì: ${message}
AI:
`;

        // 3. Generate Response
        const responseText = await generateText(systemPrompt, "medical");

        return NextResponse.json({
            role: "ai",
            content: responseText.trim()
        });

    } catch (error) {
        console.error("Medical Chat API Error:", error);
        return NextResponse.json(
            { error: "Internal Server Error" },
            { status: 500 }
        );
    }
}
